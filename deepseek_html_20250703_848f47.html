<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞–≥–∞–∑–∏–Ω –≤ Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 100%;
            padding: 10px;
        }
        .header {
            text-align: center;
            margin-bottom: 15px;
        }
        .categories {
            display: flex;
            overflow-x: auto;
            margin-bottom: 15px;
            padding-bottom: 5px;
        }
        .category {
            padding: 8px 15px;
            margin-right: 8px;
            background: #fff;
            border-radius: 20px;
            white-space: nowrap;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .category.active {
            background: #007aff;
            color: white;
        }
        .products {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .product-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        .product-info {
            padding: 10px;
        }
        .product-title {
            font-weight: 500;
            margin: 0 0 5px 0;
            font-size: 14px;
        }
        .product-price {
            font-weight: bold;
            color: #007aff;
            margin: 0 0 5px 0;
        }
        .product-stock {
            font-size: 12px;
            color: #666;
            margin: 0 0 5px 0;
        }
        .add-to-cart {
            width: 100%;
            padding: 8px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .add-to-cart:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .cart-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #007aff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ù–∞—à –º–∞–≥–∞–∑–∏–Ω</h1>
        </div>
        
        <div class="categories" id="categories">
            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        
        <div id="loading" class="loading">
            –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...
        </div>
        
        <div class="products" id="products">
            <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>
    
    <div class="cart-button" id="cartButton" style="display: none;">
        <span id="cartIcon">üõí</span>
        <span class="cart-count" id="cartCount">0</span>
    </div>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram
        const initData = tg.initData || '';
        const initDataUnsafe = tg.initDataUnsafe || {};
        const user = initDataUnsafe.user || {};
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const categoriesEl = document.getElementById('categories');
        const productsEl = document.getElementById('products');
        const loadingEl = document.getElementById('loading');
        const cartButton = document.getElementById('cartButton');
        const cartCountEl = document.getElementById('cartCount');
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let products = [];
        let categories = [];
        let cart = {};
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets
        async function loadData() {
            try {
                // –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–æ—Ç URL –Ω–∞ URL –≤–∞—à–µ–≥–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Google Apps Script
                const scriptUrl = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
                
                const response = await fetch(scriptUrl);
                const data = await response.json();
                
                if (data.success) {
                    products = data.products;
                    processProducts();
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function processProducts() {
            // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            categories = [...new Set(products.map(product => product.category))];
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            renderCategories();
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            renderProducts(products);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            loadingEl.style.display = 'none';
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function renderCategories() {
            categoriesEl.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º "–í—Å–µ" –∫–∞–∫ –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            const allCategory = document.createElement('div');
            allCategory.className = 'category active';
            allCategory.textContent = '–í—Å–µ';
            allCategory.onclick = () => filterProductsByCategory(null);
            categoriesEl.appendChild(allCategory);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            categories.forEach(category => {
                const categoryEl = document.createElement('div');
                categoryEl.className = 'category';
                categoryEl.textContent = category;
                categoryEl.onclick = () => filterProductsByCategory(category);
                categoriesEl.appendChild(categoryEl);
            });
        }
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function filterProductsByCategory(category) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            document.querySelectorAll('.category').forEach(el => {
                el.classList.remove('active');
            });
            
            if (category === null) {
                document.querySelectorAll('.category')[0].classList.add('active');
                renderProducts(products);
            } else {
                const categoryEls = document.querySelectorAll('.category');
                for (let el of categoryEls) {
                    if (el.textContent === category) {
                        el.classList.add('active');
                        break;
                    }
                }
                
                const filteredProducts = products.filter(product => product.category === category);
                renderProducts(filteredProducts);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
        function renderProducts(productsToRender) {
            productsEl.innerHTML = '';
            
            if (productsToRender.length === 0) {
                productsEl.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            
            productsToRender.forEach(product => {
                const productEl = document.createElement('div');
                productEl.className = 'product-card';
                
                productEl.innerHTML = `
                    <img src="${product.image || 'https://via.placeholder.com/150'}" class="product-image" alt="${product.name}">
                    <div class="product-info">
                        <h3 class="product-title">${product.name}</h3>
                        <p class="product-price">${product.price} ‚ÇΩ</p>
                        <p class="product-stock">${product.stock > 0 ? `–í –Ω–∞–ª–∏—á–∏–∏: ${product.stock}` : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}</p>
                        <button class="add-to-cart" ${product.stock <= 0 ? 'disabled' : ''} data-id="${product.id}">
                            ${product.stock > 0 ? '–í –∫–æ—Ä–∑–∏–Ω—É' : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
                        </button>
                    </div>
                `;
                
                productsEl.appendChild(productEl);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–í –∫–æ—Ä–∑–∏–Ω—É"
            document.querySelectorAll('.add-to-cart').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.getAttribute('data-id');
                    addToCart(productId);
                });
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–æ—Ä–∑–∏–Ω—ã
            cartButton.style.display = 'flex';
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
        function addToCart(productId) {
            const product = products.find(p => p.id == productId);
            
            if (!product) return;
            
            if (cart[productId]) {
                if (cart[productId].quantity < product.stock) {
                    cart[productId].quantity += 1;
                } else {
                    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ');
                    return;
                }
            } else {
                cart[productId] = {
                    product: product,
                    quantity: 1
                };
            }
            
            updateCartCount();
            tg.HapticFeedback.impactOccurred('light');
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
        function updateCartCount() {
            const totalItems = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
            cartCountEl.textContent = totalItems;
            
            if (totalItems > 0) {
                cartCountEl.style.display = 'flex';
            } else {
                cartCountEl.style.display = 'none';
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            loadingEl.innerHTML = `<p style="color: red;">${message}</p>`;
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
        cartButton.addEventListener('click', () => {
            if (Object.keys(cart).length === 0) {
                tg.showAlert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
                return;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–∫–∞–∑–æ–º
            let orderMessage = '–í–∞—à –∑–∞–∫–∞–∑:\n\n';
            let total = 0;
            
            for (const [id, item] of Object.entries(cart)) {
                const productTotal = item.product.price * item.quantity;
                orderMessage += `${item.product.name} - ${item.quantity} x ${item.product.price} ‚ÇΩ = ${productTotal} ‚ÇΩ\n`;
                total += productTotal;
            }
            
            orderMessage += `\n–ò—Ç–æ–≥–æ: ${total} ‚ÇΩ`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
            tg.showConfirm(orderMessage, (confirmed) => {
                if (confirmed) {
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    sendOrderToServer();
                }
            });
        });
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function sendOrderToServer() {
            try {
                tg.showPopup({
                    title: '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞',
                    message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...'
                }, () => {});
                
                // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞
                const orderData = {
                    user: user,
                    cart: cart,
                    initData: initData
                };
                
                // –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–æ—Ç URL –Ω–∞ URL –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤
                const orderUrl = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?action=createOrder';
                
                const response = await fetch(orderUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –° –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä.');
                    cart = {};
                    updateCartCount();
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + (result.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadData();
    </script>
</body>
</html>